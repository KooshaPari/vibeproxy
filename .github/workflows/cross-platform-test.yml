name: Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Build shared core (macOS)
      run: |
        cd shared/core
        cargo build --release --features macos
    
    - name: Build macOS app
      run: |
        cd apps/macos
        swift build
    
    - name: Run macOS tests
      run: |
        cd apps/macos
        swift test || true  # Tests may not be fully implemented yet

  test-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Build shared core (Windows)
      run: |
        cd shared/core
        cargo build --release --features windows
    
    - name: Build Windows app
      run: |
        cd apps/windows
        dotnet build --configuration Release
    
    - name: Run Windows tests
      run: |
        cd apps/windows
        dotnet test --configuration Release || true

  test-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libgtk-4-dev \
          libadwaita-1-dev \
          libappindicator3-dev \
          libsecret-1-dev \
          libssl-dev
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Build shared core (Linux)
      run: |
        cd shared/core
        cargo build --release --features linux
    
    - name: Build Linux app
      run: |
        cd apps/linux
        cargo build --release
    
    - name: Run Linux tests
      run: |
        cd apps/linux
        cargo test --release

  smoke-tests:
    runs-on: ubuntu-latest
    needs: [test-macos, test-windows, test-linux]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run smoke tests
      run: |
        echo "All platform builds completed successfully"
        echo "Smoke tests would verify basic functionality across platforms"
